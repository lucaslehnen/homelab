- name: "Stoping service" 
  service:
    name: libvirtd
    state: stopped
    enabled: false
  notify: reboot
  ignore_errors: true

- name: "Uninstall libvirt packages"
  apt:
    name: "{{ packages }}"
    state: absent
    purge: true
    autoclean: true
  vars:
    packages:
      - libvirt-daemon
      - qemu-kvm
      - bridge-utils
      - virtinst
      - libvirt-daemon-system

- name: "Uninstall libvirt tools packages"
  apt:
    name: "{{ packages }}"
    state: absent
    purge: true
    autoclean: true
  vars:
    packages:
      # - virt-top
      - libguestfs-tools
      - libosinfo-bin
      - qemu-system
      - virt-manager 

- name: "Disable 'vhost_net' kernel module"
  lineinfile:
    path: /etc/modules-load.d/modules.conf
    line: vhost_net
    state: absent
  notify: reboot

- name: "Disable kvm_intel kernel module"
  file:
    path: /etc/modprobe.d/qemu-system-x86.conf    
    state: absent    
  notify: reboot