# Accept the VMware End User License Agreement
vmaccepteula

# Set the root password for DCUI
rootpw {{ esxi.ssh_pass }}

# Install on the first local disk available on machine
install --firstdisk --overwritevmfs

# Set the network to Static on the first network adapter
network --hostname=esxi --device=vmnic0 --bootproto=static --ip={{ esxi.address }} --netmask={{ esxi.netmask }} --gateway={{ esxi.gateway }} --nameserver={{ esxi.nameserver }}

# Reboot
reboot

# Use busybox interpreter
%firstboot --interpreter=busybox

# Set DNS Suffix
esxcli network ip dns search add --domain=tchecode.local

# Disable IPv6
esxcli network ip set --ipv6-enabled=false

# Enable NTP
echo "server 0.br.pool.ntp.org" >> /etc/ntp.conf;
echo "server 1.br.pool.ntp.org" >> /etc/ntp.conf;
/sbin/chkconfig ntpd on;

# This allows Packer to infer the guest IP from ESXi, without the VM needing to report it itself.
esxcli system settings advanced set -o /Net/GuestIPHack -i 1

# Put host in maintenance mode
esxcli system maintenanceMode set -e true

# Reboot to apply settings (disabling IPv6)
esxcli system shutdown reboot -d 15 -r "rebooting after disabling IPv6"

# Put host in maintenance mode
esxcli system maintenanceMode set -e false

# Enable SSH
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh
